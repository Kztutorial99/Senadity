{% extends "base.html" %}

{% block title %}API Key Management - Admin{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-2">
                        <i class="fas fa-key text-primary me-2"></i>
                        API Key Management
                    </h1>
                    <p class="text-muted mb-0">Kelola API key pengguna - Generate, Enable/Disable, Extend, Delete</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#generateKeyModal">
                        <i class="fas fa-plus-circle me-2"></i>Generate New Key
                    </button>
                    <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#bulkActionsModal">
                        <i class="fas fa-tasks me-2"></i>Bulk Actions
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm bg-gradient-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Active Keys</h6>
                            <h4 class="mb-0">{{ users|selectattr('api_key')|selectattr('api_key_enabled', 'equalto', True)|list|length }}</h4>
                        </div>
                        <i class="fas fa-key-skeleton fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm bg-gradient-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Disabled Keys</h6>
                            <h4 class="mb-0">{{ users|selectattr('api_key')|selectattr('api_key_enabled', 'equalto', False)|list|length }}</h4>
                        </div>
                        <i class="fas fa-ban fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm bg-gradient-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Expired Keys</h6>
                            {% set expired_count = 0 %}
                                    {% for user in users %}
                                        {% if user.api_key_expiry and user.api_key_expiry < moment() %}
                                            {% set expired_count = expired_count + 1 %}
                                        {% endif %}
                                    {% endfor %}
                                    <h4 class="mb-0">{{ expired_count }}</h4>
                        </div>
                        <i class="fas fa-clock fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm bg-gradient-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-1">Total Users</h6>
                            <h4 class="mb-0">{{ users|length }}</h4>
                        </div>
                        <i class="fas fa-users fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Cards -->
    <div class="row mb-4">
        <div class="col-md-2 mb-3">
            <div class="card border-0 shadow-sm border-start border-success border-4 h-100">
                <div class="card-body text-center py-4">
                    <i class="fas fa-plus-circle text-success fa-3x mb-3"></i>
                    <h6 class="fw-bold">Generate Key</h6>
                    <p class="text-muted small mb-3">Buat API key baru</p>
                    <button class="btn btn-success btn-sm w-100" data-bs-toggle="modal" data-bs-target="#generateKeyModal">
                        <i class="fas fa-plus me-1"></i>Generate
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-2 mb-3">
            <div class="card border-0 shadow-sm border-start border-warning border-4 h-100">
                <div class="card-body text-center py-4">
                    <i class="fas fa-calendar-plus text-warning fa-3x mb-3"></i>
                    <h6 class="fw-bold">Extend Time</h6>
                    <p class="text-muted small mb-3">Perpanjang masa berlaku</p>
                    <button class="btn btn-warning btn-sm w-100" data-bs-toggle="modal" data-bs-target="#extendKeyModal">
                        <i class="fas fa-clock me-1"></i>Extend
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-2 mb-3">
            <div class="card border-0 shadow-sm border-start border-info border-4 h-100">
                <div class="card-body text-center py-4">
                    <i class="fas fa-toggle-on text-info fa-3x mb-3"></i>
                    <h6 class="fw-bold">Toggle Status</h6>
                    <p class="text-muted small mb-3">Enable/Disable key</p>
                    <button class="btn btn-info btn-sm w-100" onclick="showBulkToggle()">
                        <i class="fas fa-power-off me-1"></i>Toggle
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-2 mb-3">
            <div class="card border-0 shadow-sm border-start border-danger border-4 h-100">
                <div class="card-body text-center py-4">
                    <i class="fas fa-trash-alt text-danger fa-3x mb-3"></i>
                    <h6 class="fw-bold">Delete Key</h6>
                    <p class="text-muted small mb-3">Hapus API key</p>
                    <button class="btn btn-danger btn-sm w-100" data-bs-toggle="modal" data-bs-target="#deleteKeyModal">
                        <i class="fas fa-trash me-1"></i>Delete
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-2 mb-3">
            <div class="card border-0 shadow-sm border-start border-purple border-4 h-100">
                <div class="card-body text-center py-4">
                    <i class="fas fa-sync-alt text-purple fa-3x mb-3"></i>
                    <h6 class="fw-bold">Regenerate</h6>
                    <p class="text-muted small mb-3">Generate ulang key</p>
                    <button class="btn btn-purple btn-sm w-100" data-bs-toggle="modal" data-bs-target="#regenerateKeyModal">
                        <i class="fas fa-redo me-1"></i>Regenerate
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-2 mb-3">
            <div class="card border-0 shadow-sm border-start border-dark border-4 h-100">
                <div class="card-body text-center py-4">
                    <i class="fas fa-crown text-warning fa-3x mb-3"></i>
                    <h6 class="fw-bold">Set Premium</h6>
                    <p class="text-muted small mb-3">Aktifkan premium</p>
                    <button class="btn btn-dark btn-sm w-100" data-bs-toggle="modal" data-bs-target="#premiumModal">
                        <i class="fas fa-star me-1"></i>Premium
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- API Keys List -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 py-3">
            <h5 class="card-title mb-0">
                <i class="fas fa-list text-info me-2"></i>
                User API Keys
            </h5>
        </div>
        <div class="card-body p-0">
            {% if users %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>User</th>
                                <th>API Key</th>
                                <th>Status</th>
                                <th>Expiry</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="user-avatar d-flex align-items-center justify-content-center me-3" style="width: 35px; height: 35px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; color: white; font-weight: bold;">
                                            {{ user.username[0].upper() }}
                                        </div>
                                        <div>
                                            <div class="fw-medium">{{ user.username }}</div>
                                            <small class="text-muted">{{ user.email or 'No email' }}</small>
                                            {% if user.is_premium %}
                                                <span class="badge bg-warning text-dark">PREMIUM</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if user.api_key %}
                                        <div class="d-flex align-items-center">
                                            <code class="bg-light p-1 rounded me-2" style="font-size: 0.8rem;">{{ user.api_key[:20] }}...</code>
                                            <button class="btn btn-sm btn-outline-secondary" onclick="copyApiKey('{{ user.api_key }}')">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    {% else %}
                                        <span class="text-muted">No API Key</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if user.api_key %}
                                        {% if hasattr(user, 'api_key_enabled') and user.api_key_enabled %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-danger">Disabled</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary">No Key</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if hasattr(user, 'api_key_expiry') and user.api_key_expiry %}
                                        <small class="text-muted">{{ user.api_key_expiry.strftime('%Y-%m-%d') }}</small>
                                        {% if user.api_key_expiry < moment() %}
                                            <br><span class="badge bg-danger">Expired</span>
                                        {% endif %}
                                    {% else %}
                                        <small class="text-muted">No Expiry</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'N/A' }}</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        {% if user.api_key %}
                                            {% if hasattr(user, 'api_key_enabled') and user.api_key_enabled %}
                                                <form method="POST" action="{{ url_for('admin_toggle_api_key_status') }}" class="d-inline">
                                                    <input type="hidden" name="user_id" value="{{ user.id }}">
                                                    <input type="hidden" name="action" value="disable">
                                                    <button type="submit" class="btn btn-outline-danger" title="Disable">
                                                        <i class="fas fa-pause"></i>
                                                    </button>
                                                </form>
                                            {% else %}
                                                <form method="POST" action="{{ url_for('admin_toggle_api_key_status') }}" class="d-inline">
                                                    <input type="hidden" name="user_id" value="{{ user.id }}">
                                                    <input type="hidden" name="action" value="enable">
                                                    <button type="submit" class="btn btn-outline-success" title="Enable">
                                                        <i class="fas fa-play"></i>
                                                    </button>
                                                </form>
                                            {% endif %}
                                        {% endif %}
                                        
                                        <button class="btn btn-outline-warning" onclick="extendKey({{ user.id }}, '{{ user.username }}')" title="Extend">
                                            <i class="fas fa-clock"></i>
                                        </button>
                                        
                                        <button class="btn btn-outline-primary" onclick="regenerateKey({{ user.id }}, '{{ user.username }}')" title="Regenerate">
                                            <i class="fas fa-refresh"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-users-slash text-muted mb-3" style="font-size: 3rem;"></i>
                    <h5 class="text-muted">No users found</h5>
                    <p class="text-muted">No active users to manage API keys.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Generate API Key Modal -->
<div class="modal fade" id="generateKeyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-key me-2"></i>Generate New API Key
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin_generate_api_key') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-user me-2"></i>Select User
                                </label>
                                <select class="form-select" name="user_id" required onchange="updateUserInfo(this)">
                                    <option value="">Choose user...</option>
                                    {% for user in users %}
                                    <option value="{{ user.id }}" 
                                            data-username="{{ user.username }}" 
                                            data-email="{{ user.email or 'No email' }}" 
                                            data-premium="{{ user.is_premium }}"
                                            data-balance="{{ user.balance }}">
                                        {{ user.username }} ({{ user.email or 'No email' }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-calendar me-2"></i>Expiry (days)
                                </label>
                                <select class="form-select" name="expiry_days">
                                    <option value="">No expiry (Permanent)</option>
                                    <option value="7">7 days</option>
                                    <option value="30">30 days</option>
                                    <option value="90">90 days</option>
                                    <option value="180">180 days</option>
                                    <option value="365">365 days</option>
                                    <option value="custom">Custom...</option>
                                </select>
                                <input type="number" class="form-control mt-2 d-none" name="custom_expiry" placeholder="Enter custom days" min="1" max="3650">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-toggle-on me-2"></i>Initial Status
                                </label>
                                <select class="form-select" name="initial_status">
                                    <option value="enabled">Enabled (Active)</option>
                                    <option value="disabled">Disabled (Inactive)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-crown me-2"></i>Set Premium Access
                                </label>
                                <select class="form-select" name="set_premium">
                                    <option value="">Keep current status</option>
                                    <option value="enable">Enable Premium</option>
                                    <option value="disable">Disable Premium</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-sticky-note me-2"></i>Admin Notes
                        </label>
                        <textarea class="form-control" name="admin_notes" rows="3" placeholder="Optional notes about this API key generation..."></textarea>
                    </div>

                    <!-- User Info Display -->
                    <div id="selectedUserInfo" class="alert alert-light d-none">
                        <h6><i class="fas fa-info-circle me-2"></i>Selected User Information:</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <small><strong>Username:</strong> <span id="infoUsername">-</span></small><br>
                                <small><strong>Email:</strong> <span id="infoEmail">-</span></small>
                            </div>
                            <div class="col-md-6">
                                <small><strong>Premium:</strong> <span id="infoPremium">-</span></small><br>
                                <small><strong>Balance:</strong> Rp <span id="infoBalance">-</span></small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> This will generate a new API key for the selected user. Any existing API key will be replaced and become invalid.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-key me-2"></i>Generate API Key
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete API Key Modal -->
<div class="modal fade" id="deleteKeyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-trash-alt me-2"></i>Delete API Key
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin_delete_api_key') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Select User</label>
                        <select class="form-select" name="user_id" required>
                            <option value="">Choose user...</option>
                            {% for user in users %}
                                {% if user.api_key %}
                                <option value="{{ user.id }}">{{ user.username }} - {{ user.api_key[:20] }}...</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Reason for Deletion</label>
                        <textarea class="form-control" name="deletion_reason" rows="3" placeholder="Enter reason for deleting this API key..." required></textarea>
                    </div>

                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Danger:</strong> This action cannot be undone. The API key will be permanently deleted and all applications using it will stop working.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Delete API Key
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Regenerate API Key Modal -->
<div class="modal fade" id="regenerateKeyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-sync-alt me-2"></i>Regenerate API Key
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin_regenerate_api_key') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Select User</label>
                        <select class="form-select" name="user_id" required>
                            <option value="">Choose user...</option>
                            {% for user in users %}
                                {% if user.api_key %}
                                <option value="{{ user.id }}">{{ user.username }} - {{ user.api_key[:20] }}...</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Keep Current Expiry</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="keep_expiry" id="keepExpiry" checked>
                            <label class="form-check-label" for="keepExpiry">
                                Maintain current expiry date
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Reason for Regeneration</label>
                        <textarea class="form-control" name="regeneration_reason" rows="3" placeholder="Enter reason for regenerating this API key..."></textarea>
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> This will create a new API key and invalidate the current one. All applications using the old key will need to be updated.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-info">
                        <i class="fas fa-sync-alt me-2"></i>Regenerate Key
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Set Premium Modal -->
<div class="modal fade" id="premiumModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-crown me-2"></i>Manage Premium Access
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin_set_premium') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Select User</label>
                        <select class="form-select" name="user_id" required>
                            <option value="">Choose user...</option>
                            {% for user in users %}
                            <option value="{{ user.id }}" data-premium="{{ user.is_premium }}">
                                {{ user.username }} 
                                {% if user.is_premium %}
                                    <span class="badge bg-warning">PREMIUM</span>
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Premium Action</label>
                        <select class="form-select" name="premium_action" required>
                            <option value="">Choose action...</option>
                            <option value="enable">Enable Premium</option>
                            <option value="disable">Disable Premium</option>
                            <option value="extend">Extend Premium</option>
                        </select>
                    </div>

                    <div class="mb-3 d-none" id="premiumDuration">
                        <label class="form-label fw-bold">Premium Duration</label>
                        <select class="form-select" name="premium_duration">
                            <option value="30">30 days</option>
                            <option value="90">90 days</option>
                            <option value="180">180 days</option>
                            <option value="365">365 days</option>
                            <option value="lifetime">Lifetime</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Add Balance (Optional)</label>
                        <input type="number" class="form-control" name="add_balance" placeholder="Enter amount to add to user balance" min="0" step="1000">
                        <div class="form-text">Leave empty to not change balance</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-crown me-2"></i>Update Premium
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Actions Modal -->
<div class="modal fade" id="bulkActionsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-tasks me-2"></i>Bulk Actions
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin_bulk_api_actions') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Select Users</label>
                        <div class="border p-3 rounded" style="max-height: 200px; overflow-y: auto;">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleAllUsers()">
                                <label class="form-check-label fw-bold" for="selectAll">
                                    Select All Users
                                </label>
                            </div>
                            <hr>
                            {% for user in users %}
                            <div class="form-check">
                                <input class="form-check-input user-checkbox" type="checkbox" name="user_ids[]" value="{{ user.id }}" id="user{{ user.id }}">
                                <label class="form-check-label" for="user{{ user.id }}">
                                    {{ user.username }} 
                                    {% if user.api_key %}
                                        <small class="text-success">(Has Key)</small>
                                    {% else %}
                                        <small class="text-muted">(No Key)</small>
                                    {% endif %}
                                    {% if user.is_premium %}
                                        <span class="badge bg-warning text-dark">PREMIUM</span>
                                    {% endif %}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Bulk Action</label>
                        <select class="form-select" name="bulk_action" required>
                            <option value="">Choose action...</option>
                            <option value="enable_keys">Enable All Selected Keys</option>
                            <option value="disable_keys">Disable All Selected Keys</option>
                            <option value="extend_keys">Extend All Selected Keys</option>
                            <option value="delete_keys">Delete All Selected Keys</option>
                            <option value="regenerate_keys">Regenerate All Selected Keys</option>
                            <option value="set_premium">Set Premium for All Selected</option>
                            <option value="add_balance">Add Balance to All Selected</option>
                        </select>
                    </div>

                    <div class="mb-3 d-none" id="bulkExtendDays">
                        <label class="form-label fw-bold">Extend by (days)</label>
                        <select class="form-select" name="extend_days">
                            <option value="30">30 days</option>
                            <option value="90">90 days</option>
                            <option value="180">180 days</option>
                            <option value="365">365 days</option>
                        </select>
                    </div>

                    <div class="mb-3 d-none" id="bulkBalance">
                        <label class="form-label fw-bold">Balance Amount</label>
                        <input type="number" class="form-control" name="balance_amount" placeholder="Enter amount to add" min="0" step="1000">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-play me-2"></i>Execute Bulk Action
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Extend Key Modal -->
<div class="modal fade" id="extendKeyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-clock me-2"></i>Extend API Key
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin_extend_api_key') }}">
                <div class="modal-body">
                    <input type="hidden" name="user_id" id="extendUserId">
                    
                    <div class="mb-3">
                        <label class="form-label">Selected User</label>
                        <input type="text" class="form-control" id="extendUserName" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Extend by (days)</label>
                        <select class="form-select" name="extend_days" required>
                            <option value="">Choose duration...</option>
                            <option value="7">7 days</option>
                            <option value="30">30 days</option>
                            <option value="90">90 days</option>
                            <option value="180">180 days</option>
                            <option value="365">365 days</option>
                        </select>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        This will extend the API key expiry date by the selected number of days.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-clock me-2"></i>Extend Key
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Enhanced JavaScript for API Key Management
function copyApiKey(apiKey) {
    navigator.clipboard.writeText(apiKey).then(function() {
        showToast('API key copied to clipboard!', 'success');
    }, function() {
        showToast('Failed to copy API key', 'error');
    });
}

function updateUserInfo(select) {
    const option = select.selectedOptions[0];
    const infoDiv = document.getElementById('selectedUserInfo');
    
    if (option && option.value) {
        document.getElementById('infoUsername').textContent = option.dataset.username;
        document.getElementById('infoEmail').textContent = option.dataset.email;
        document.getElementById('infoPremium').textContent = option.dataset.premium === 'True' ? 'Yes' : 'No';
        document.getElementById('infoBalance').textContent = parseFloat(option.dataset.balance).toLocaleString();
        infoDiv.classList.remove('d-none');
    } else {
        infoDiv.classList.add('d-none');
    }
}

function toggleAllUsers() {
    const selectAll = document.getElementById('selectAll');
    const userCheckboxes = document.querySelectorAll('.user-checkbox');
    
    userCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

function extendKey(userId, username) {
    document.getElementById('extendUserId').value = userId;
    document.getElementById('extendUserName').value = username;
    new bootstrap.Modal(document.getElementById('extendKeyModal')).show();
}

function regenerateKey(userId, username) {
    if (confirm(`Are you sure you want to regenerate API key for ${username}? This will invalidate the current key.`)) {
        // Set the form data and submit
        const form = document.querySelector('#regenerateKeyModal form');
        const userSelect = form.querySelector('select[name="user_id"]');
        userSelect.value = userId;
        
        new bootstrap.Modal(document.getElementById('regenerateKeyModal')).show();
    }
}

function quickToggleStatus(userId, currentStatus) {
    const action = currentStatus ? 'disable' : 'enable';
    const actionText = currentStatus ? 'disable' : 'enable';
    
    if (confirm(`Are you sure you want to ${actionText} this API key?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("admin_toggle_api_key_status") }}';
        
        const userIdInput = document.createElement('input');
        userIdInput.type = 'hidden';
        userIdInput.name = 'user_id';
        userIdInput.value = userId;
        
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = action;
        
        form.appendChild(userIdInput);
        form.appendChild(actionInput);
        document.body.appendChild(form);
        form.submit();
    }
}

function quickDeleteKey(userId, username) {
    if (confirm(`Are you sure you want to delete API key for ${username}? This action cannot be undone!`)) {
        const reason = prompt('Please enter a reason for deletion:');
        if (reason) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("admin_delete_api_key") }}';
            
            const userIdInput = document.createElement('input');
            userIdInput.type = 'hidden';
            userIdInput.name = 'user_id';
            userIdInput.value = userId;
            
            const reasonInput = document.createElement('input');
            reasonInput.type = 'hidden';
            reasonInput.name = 'deletion_reason';
            reasonInput.value = reason;
            
            form.appendChild(userIdInput);
            form.appendChild(reasonInput);
            document.body.appendChild(form);
            form.submit();
        }
    }
}

function showBulkToggle() {
    new bootstrap.Modal(document.getElementById('bulkActionsModal')).show();
    // Pre-select toggle action
    document.querySelector('select[name="bulk_action"]').value = 'toggle_keys';
}

function showToast(message, type, duration = 5000) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
    toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, duration);
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Handle expiry select change
    const expirySelect = document.querySelector('select[name="expiry_days"]');
    const customExpiryInput = document.querySelector('input[name="custom_expiry"]');
    
    if (expirySelect && customExpiryInput) {
        expirySelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customExpiryInput.classList.remove('d-none');
                customExpiryInput.required = true;
            } else {
                customExpiryInput.classList.add('d-none');
                customExpiryInput.required = false;
            }
        });
    }

    // Handle bulk action change
    const bulkActionSelect = document.querySelector('select[name="bulk_action"]');
    const bulkExtendDiv = document.getElementById('bulkExtendDays');
    const bulkBalanceDiv = document.getElementById('bulkBalance');
    
    if (bulkActionSelect) {
        bulkActionSelect.addEventListener('change', function() {
            // Hide all conditional fields first
            if (bulkExtendDiv) bulkExtendDiv.classList.add('d-none');
            if (bulkBalanceDiv) bulkBalanceDiv.classList.add('d-none');
            
            // Show relevant fields based on selection
            if (this.value === 'extend_keys' && bulkExtendDiv) {
                bulkExtendDiv.classList.remove('d-none');
            } else if (this.value === 'add_balance' && bulkBalanceDiv) {
                bulkBalanceDiv.classList.remove('d-none');
            }
        });
    }

    // Handle premium action change
    const premiumActionSelect = document.querySelector('select[name="premium_action"]');
    const premiumDurationDiv = document.getElementById('premiumDuration');
    
    if (premiumActionSelect && premiumDurationDiv) {
        premiumActionSelect.addEventListener('change', function() {
            if (this.value === 'enable' || this.value === 'extend') {
                premiumDurationDiv.classList.remove('d-none');
            } else {
                premiumDurationDiv.classList.add('d-none');
            }
        });
    }
});

// Auto-refresh functionality
let autoRefreshInterval;

function toggleAutoRefresh() {
    const refreshBtn = document.getElementById('autoRefreshBtn');
    
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        refreshBtn.innerHTML = '<i class="fas fa-play me-1"></i>Start Auto-Refresh';
        refreshBtn.classList.remove('btn-danger');
        refreshBtn.classList.add('btn-success');
    } else {
        autoRefreshInterval = setInterval(() => {
            location.reload();
        }, 30000); // Refresh every 30 seconds
        
        refreshBtn.innerHTML = '<i class="fas fa-stop me-1"></i>Stop Auto-Refresh';
        refreshBtn.classList.remove('btn-success');
        refreshBtn.classList.add('btn-danger');
        
        showToast('Auto-refresh enabled (30s interval)', 'info');
    }
}
</script>

<style>
.btn-purple {
    background-color: #6f42c1;
    border-color: #6f42c1;
    color: white;
}

.btn-purple:hover {
    background-color: #5a2d91;
    border-color: #5a2d91;
    color: white;
}

.border-purple {
    border-color: #6f42c1 !important;
}

.text-purple {
    color: #6f42c1 !important;
}

.bg-gradient-success {
    background: linear-gradient(45deg, #28a745, #20c997);
}

.bg-gradient-warning {
    background: linear-gradient(45deg, #ffc107, #fd7e14);
}

.bg-gradient-danger {
    background: linear-gradient(45deg, #dc3545, #e83e8c);
}

.bg-gradient-info {
    background: linear-gradient(45deg, #17a2b8, #6610f2);
}

.card:hover {
    transform: translateY(-2px);
    transition: all 0.3s ease;
}

.table th {
    border-top: none;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.85rem;
    letter-spacing: 0.5px;
}

.badge {
    font-size: 0.7rem;
}

@media (max-width: 768px) {
    .col-md-2 {
        margin-bottom: 1rem;
    }
    
    .table-responsive {
        font-size: 0.9rem;
    }
}
</style>
{% endblock %}